name: Publish JavaDoc to GitHub Pages

on:
  push:
    tags:
      - 'v*'        # runs automatically on v1.0.0, v1.1.0, etc.
  workflow_dispatch:
    inputs:
      version:
        description: 'Library version to publish docs for (e.g. 1.1.0)'
        required: true

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Set up JDK 8
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: '8'

      - name: Build JavaDoc
        run: |
          set -e
          mvn -B javadoc:javadoc
          echo "=== TARGET LAYOUT ==="
          ls -R .

      - name: Prepare versioned docs
        env:
          DOCS_VERSION: ${{ github.event.inputs.version }}
        run: |
          set -e

          # Prefer explicit input when run manually; fall back to tag name
          if [ -n "${DOCS_VERSION}" ]; then
            VERSION="${DOCS_VERSION}"
            echo "Running via workflow_dispatch for version: ${VERSION}"
          else
            VERSION="${GITHUB_REF_NAME#v}"   # strip leading 'v' from tag
            echo "Running via tag push for version: ${VERSION}"
          fi

          if [ -z "${VERSION}" ]; then
            echo "ERROR: VERSION is empty. Provide an input when running manually, or trigger via tag."
            exit 1
          fi

          # Try to locate apidocs anywhere under the repo (handles multi-module layouts)
          APIDOCS_DIR="$(find . -type d -path '*/target/site/apidocs' | head -n 1 || true)"

          echo "Detected APIDOCS_DIR='${APIDOCS_DIR}'"

          if [ -z "${APIDOCS_DIR}" ]; then
            echo "ERROR: Could not find any 'target/site/apidocs' directory in the workspace."
            echo "Check the 'Build JavaDoc' step logs above to see where (or if) Javadoc was generated."
            exit 1
          fi

          mkdir -p public

          # Put this version under /<version>/
          mkdir -p "public/${VERSION}"
          cp -r "${APIDOCS_DIR}"/. "public/${VERSION}/"

          # Also update /latest/
          rm -rf public/latest
          mkdir -p public/latest
          cp -r "${APIDOCS_DIR}"/. public/latest/

      - name: Deploy to GitHub Pages
        uses: peaceiris/actions-gh-pages@v4
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          publish_branch: gh-pages
          publish_dir: public
          keep_files: true
