name: Publish JavaDoc to GitHub Pages

on:
  push:
    tags:
      - 'v*'        # runs automatically on v1.0.0, v1.1.0, etc.
  workflow_dispatch: {}

permissions:
  contents: write

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Set up JDK 8
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: '8'

      - name: Build JavaDoc
        run: |
          set -e
          mvn -B clean javadoc:javadoc
          echo "=== TARGET LAYOUT AFTER JAVADOC ==="
          ls -R target || echo "No target directory?"

      - name: Get project version from pom.xml
        id: mvn-version
        run: |
          VERSION=$(grep -m1 '<version>' pom.xml | sed -E 's/.*<version>([^<]+)<\/version>.*/\1/')
          echo "Detected project version: $VERSION"
          echo "version=$VERSION" >> "$GITHUB_OUTPUT"

      # ðŸ†• Pull existing versions from gh-pages into public/
      - name: Backfill existing versions from gh-pages
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          set -e
          mkdir -p public

          # Try to clone existing gh-pages branch (ok if it doesn't exist yet)
          git clone --depth=1 --branch gh-pages \
            "https://x-access-token:${GITHUB_TOKEN}@github.com/${GITHUB_REPOSITORY}.git" \
            gh-pages-existing || {
              echo "No existing gh-pages branch; skipping backfill."
              exit 0
            }

          # Copy all version folders except 'latest' into public/
          for d in gh-pages-existing/*/; do
            dir=$(basename "$d")
            if [ "$dir" != "latest" ]; then
              echo "Backfilling existing version folder: $dir"
              cp -R "$d" "public/$dir"
            fi
          done

      - name: Prepare versioned docs
        env:
          VERSION: ${{ steps.mvn-version.outputs.version }}
        run: |
          set -e
          echo "Preparing JavaDoc for version: ${VERSION}"

          if [ -d target/site/apidocs ]; then
            APIDOCS_DIR="target/site/apidocs"
          elif [ -d target/reports/apidocs ]; then
            APIDOCS_DIR="target/reports/apidocs"
          else
            echo "ERROR: Could not find Javadoc directory."
            exit 1
          fi
          echo "Using APIDOCS_DIR='${APIDOCS_DIR}'"

          # Put this version under /<version>/
          rm -rf "public/${VERSION}"
          mkdir -p "public/${VERSION}"
          cp -r "${APIDOCS_DIR}"/. "public/${VERSION}/"

          # Also update /latest/
          rm -rf public/latest
          mkdir -p public/latest
          cp -r "${APIDOCS_DIR}"/. public/latest/

          # ------------------------------------------------------------------
          # Build a simple index page at /chunking-collector/
          # ------------------------------------------------------------------
          # List all version folders except 'latest', sorted newest â†’ oldest
          VERSIONS=$(ls -1 public | grep -v latest | sort -rV || true)

          cat > public/index.html <<EOF
          <!DOCTYPE html>
          <html lang="en">
          <head>
            <meta charset="UTF-8" />
            <!-- Try hard to prevent caching of the index page itself -->
            <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate" />
            <meta http-equiv="Pragma" content="no-cache" />
            <meta http-equiv="Expires" content="0" />
            <title>Chunking Collector â€“ JavaDoc</title>
            <style>
              body { font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif; margin: 2rem; }
              h1 { margin-bottom: 0.5rem; }
              .versions { margin-top: 1rem; }
              .build-info { margin-top: 2rem; font-size: 0.85rem; color: #555; }
            </style>
          </head>
          <body>
            <h1>Chunking Collector â€“ JavaDoc</h1>
            <p>Select a version:</p>

            <div class="versions">
              <div>ðŸ”— <a href="./latest/">latest</a> (currently ${VERSION})</div>
          EOF

          for v in ${VERSIONS}; do
            if [ "$v" != "latest" ]; then
              echo "              <div>ðŸ”— <a href=\"./${v}/\">${v}</a></div>" >> public/index.html
            fi
          done

          cat >> public/index.html <<EOF
            </div>
            <div class="build-info">
              Generated on $(date -u +"%Y-%m-%d %H:%M:%S UTC")
            </div>
          </body>
          </html>
          EOF

      - name: Deploy to GitHub Pages
        uses: peaceiris/actions-gh-pages@v4
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          publish_branch: gh-pages
          publish_dir: public
          keep_files: true
