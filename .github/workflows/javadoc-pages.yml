name: Publish JavaDoc to GitHub Pages

on:
  push:
    tags:
      - 'v*'        # runs automatically on v1.0.0, v1.1.0, etc.
  workflow_dispatch: {}   # manual trigger, no input needed

permissions:
  contents: write

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Set up JDK 8
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: '8'

      - name: Build JavaDoc
        run: |
          set -e
          mvn -B clean javadoc:javadoc
          echo "=== TARGET LAYOUT AFTER JAVADOC ==="
          ls -R target || echo "No target directory?"

      # ðŸ”½ detect the version directly from pom.xml
      - name: Get project version from pom.xml
        id: mvn-version
        run: |
          VERSION=$(grep -m1 '<version>' pom.xml | sed -E 's/.*<version>([^<]+)<\/version>.*/\1/')
          echo "Detected project version: $VERSION"
          echo "version=$VERSION" >> "$GITHUB_OUTPUT"

      - name: Prepare versioned docs
        env:
          VERSION: ${{ steps.mvn-version.outputs.version }}
        run: |
          set -e
          echo "Preparing JavaDoc for version: ${VERSION}"

          if [ -d target/site/apidocs ]; then
            APIDOCS_DIR="target/site/apidocs"
          elif [ -d target/reports/apidocs ]; then
            APIDOCS_DIR="target/reports/apidocs"
          else
            echo "ERROR: Could not find Javadoc directory."
            exit 1
          fi
          echo "Using APIDOCS_DIR='${APIDOCS_DIR}'"

          mkdir -p public
          rm -rf "public/${VERSION}"
          mkdir -p "public/${VERSION}"
          cp -r "${APIDOCS_DIR}"/. "public/${VERSION}/"

          rm -rf public/latest
          mkdir -p public/latest
          cp -r "${APIDOCS_DIR}"/. public/latest/

          # ------------------------------------------------------------------
          # Build a simple index page at /chunking-collector/
          # ------------------------------------------------------------------
          VERSIONS=$(ls -1 public | grep -v latest || true)

          cat > public/index.html <<EOF
          <!DOCTYPE html>
          <html lang="en">
          <head>
            <meta charset="UTF-8" />
            <title>Chunking Collector â€“ JavaDoc</title>
            <style>
              body { font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif; margin: 2rem; }
              h1 { margin-bottom: 0.5rem; }
              .versions { margin-top: 1rem; }
            </style>
          </head>
          <body>
            <h1>Chunking Collector â€“ JavaDoc</h1>
            <p>Select a version:</p>
            <div class="versions">
              <div>ðŸ”— <a href="./latest/">latest</a> (currently ${VERSION})</div>
          EOF

          for v in ${VERSIONS}; do
            if [ "$v" != "latest" ]; then
              echo "              <div>ðŸ”— <a href=\"./${v}/\">${v}</a></div>" >> public/index.html
            fi
          done

          cat >> public/index.html <<EOF
            </div>
          </body>
          </html>
          EOF

      - name: Deploy to GitHub Pages
        uses: peaceiris/actions-gh-pages@v4
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          publish_branch: gh-pages
          publish_dir: public
          keep_files: true
