name: Publish JavaDoc to GitHub Pages

on:
  push:
    tags:
      - 'v*'        # runs automatically on v1.0.0, v1.1.0, etc.
  workflow_dispatch:
    inputs:
      version:
        description: 'Library version to publish docs for (e.g. 1.1.0)'
        required: true

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Set up JDK 8
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: '8'

      - name: Build JavaDoc
        run: |
          set -e
          # Match what you run locally
          mvn -B clean javadoc:javadoc

          echo "=== TARGET LAYOUT AFTER JAVADOC ==="
          ls -R target || echo "No target directory?"

      - name: Prepare versioned docs
        env:
          DOCS_VERSION: ${{ github.event.inputs.version }}
        run: |
          set -e

          # Prefer explicit input when run manually; fall back to tag name
          if [ -n "${DOCS_VERSION}" ]; then
            VERSION="${DOCS_VERSION}"
            echo "Running via workflow_dispatch for version: ${VERSION}"
          else
            VERSION="${GITHUB_REF_NAME#v}"   # strip leading 'v' from tag
            echo "Running via tag push for version: ${VERSION}"
          fi

          if [ -z "${VERSION}" ]; then
            echo "ERROR: VERSION is empty. Provide an input when running manually, or trigger via tag."
            exit 1
          fi

          if [ ! -d target/site/apidocs ]; then
            echo "ERROR: JavaDoc output directory 'target/site/apidocs' not found."
            echo "Check the 'Build JavaDoc' step logs above to see why it was not created."
            exit 1
          fi

          mkdir -p public

          # Put this version under /<version>/
          rm -rf "public/${VERSION}"
          mkdir -p "public/${VERSION}"
          cp -r target/site/apidocs/. "public/${VERSION}/"

          # Also update /latest/
          rm -rf public/latest
          mkdir -p public/latest
          cp -r target/site/apidocs/. public/latest/

      - name: Deploy to GitHub Pages
        uses: peaceiris/actions-gh-pages@v4
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          publish_branch: gh-pages
          publish_dir: public
          keep_files: true
